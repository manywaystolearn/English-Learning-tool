
  <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Indian Accent Story Reader</title>
<style>
  body {
    margin: 0;
    padding: 0;
    background: black;
    font-family: Arial, sans-serif;
    color: white;
    font-weight: bold;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  #speedControl {
    position: sticky;
    top: 0;
    background: #111;
    padding: 8px 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    z-index: 10;
    font-size: 22px;
    border-bottom: 1px solid #333;
  }
  #rate {
    width: 150px;
    height: 25px;
    cursor: pointer;
  }
  #rateValue {
    min-width: 35px;
    text-align: right;
  }
  #storyContainer {
    flex: 1;
    padding: 15px;
    font-size: 26px;
    line-height: 1.8;
    overflow-y: auto;
    outline: none;
    white-space: pre-wrap;
    cursor: text;
  }
  .highlight {
    background-color: white;
    color: black;
    border-radius: 4px;
    padding: 2px 4px;
  }
  #readBtn {
    display: none; /* Hide the Read Story button */
  }
</style>
</head>
<body>

<div id="speedControl">
  <label for="rate">Speed: <span id="rateValue">1</span>x</label>
  <input type="range" id="rate" min="0.5" max="2" value="1" step="0.1" />
</div>

<div id="storyContainer" contenteditable="true" placeholder="Paste or write your story here..."></div>

<button id="readBtn">â–¶ Read Story</button>

<script>
const storyContainer = document.getElementById("storyContainer");
const rate = document.getElementById("rate");
const rateValue = document.getElementById("rateValue");
const readBtn = document.getElementById("readBtn");
let voices = [];

function loadVoices() {
  voices = speechSynthesis.getVoices();
}
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

rate.addEventListener("input", () => {
  rateValue.textContent = rate.value;
});

let parts = [];
let partsRanges = []; // Store start/end character indexes for each part
let currentIndex = 0;

// Split text into parts AND store their exact character ranges
function splitTextWithRanges(text) {
  let regex = /[^,.!?;:]+[,.!?;:]?|[^,.!?;:]+/g;
  let match;
  let partsArr = [];
  let ranges = [];

  while ((match = regex.exec(text)) !== null) {
    partsArr.push(match[0]);
    ranges.push({ start: match.index, end: match.index + match[0].length });
  }
  return { partsArr, ranges };
}

// Find the part index where caret is located
function getPartIndexFromCaret(caretPos) {
  for (let i = 0; i < partsRanges.length; i++) {
    const range = partsRanges[i];
    if (caretPos >= range.start && caretPos < range.end) {
      return i;
    }
  }
  return partsRanges.length - 1; // fallback last part
}

function renderText(indexToHighlight) {
  if (!parts.length) return;
  let highlightedText = parts.map((part, i) =>
    i === indexToHighlight ? `<span class="highlight" id="current">${part.trim()}</span>` : part.trim()
  ).join(" ");

  storyContainer.innerHTML = highlightedText;

  storyContainer.focus();
  window.getSelection().removeAllRanges();

  const currentSpan = document.getElementById("current");
  if (currentSpan) {
    currentSpan.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}

function getCaretCharacterOffsetWithin(element) {
  const sel = window.getSelection();
  if (sel.rangeCount > 0) {
    const range = sel.getRangeAt(0);
    const preCaretRange = range.cloneRange();
    preCaretRange.selectNodeContents(element);
    preCaretRange.setEnd(range.endContainer, range.endOffset);
    return preCaretRange.toString().length;
  }
  return -1;
}

// On click: get caret position, calculate part index precisely, then read
storyContainer.addEventListener("click", () => {
  if (speechSynthesis.speaking) {
    speechSynthesis.cancel();
  }

  let text = storyContainer.innerText;
  if (!text) return;

  let result = splitTextWithRanges(text);
  parts = result.partsArr;
  partsRanges = result.ranges;

  const caretPos = getCaretCharacterOffsetWithin(storyContainer);
  if (caretPos === -1) {
    currentIndex = 0;
  } else {
    currentIndex = getPartIndexFromCaret(caretPos);
  }

  renderText(currentIndex);
  speakFromIndex();
});

function speakFromIndex() {
  if (currentIndex >= parts.length) {
    // Reset text highlight after finishing
    let fullText = parts.join(" ");
    storyContainer.innerHTML = fullText
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\n/g, "<br>");
    return;
  }

  renderText(currentIndex);

  const utterance = new SpeechSynthesisUtterance(parts[currentIndex]);
  const indianVoice = voices.find(v => v.lang === "en-IN" || v.name.toLowerCase().includes("india"));
  if (indianVoice) utterance.voice = indianVoice;

  utterance.rate = parseFloat(rate.value);

  utterance.onend = () => {
    let delay = 0;
    if (/[.!?]/.test(parts[currentIndex].slice(-1))) {
      delay = 350;
    } else if (/[,;:]/.test(parts[currentIndex].slice(-1))) {
      delay = 200;
    } else {
      delay = 100;
    }

    setTimeout(() => {
      currentIndex++;
      speakFromIndex();
    }, delay);
  };

  speechSynthesis.speak(utterance);
}
</script>

</body>
</html>